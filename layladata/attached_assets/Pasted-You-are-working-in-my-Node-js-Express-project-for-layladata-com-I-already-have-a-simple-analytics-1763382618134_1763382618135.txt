You are working in my Node.js + Express project for layladata.com. I already have a simple analytics page at /layla-analytics-aurora-741 and a basic /api/track endpoint. Replace and extend it to give me trustworthy, goal-oriented analytics without any secrets for now.

OBJECTIVE
I need reliable daily unique visitors and a simple funnel to ticket purchase. Show progress to a daily goal of 150 unique visitors. Filter bots and dev noise. Capture UTM parameters and referrers. Track “Tickets” clicks and purchases (via redirect and optional webhook). Update the dashboard at /layla-analytics-aurora-741 to display everything in real time.

STACK CONSTRAINTS
- Keep using Node.js + Express.
- Use a local SQLite database at /data/analytics.db (create folder if missing).
- Do not add auth. The analytics URL remains a hard-to-guess slug.
- Keep code self-contained. No external services are required.

DATA MODEL (SQLite)
Create tables:

sessions(
  id TEXT PRIMARY KEY,             -- sid (uuid v4)
  visitor_id TEXT,                 -- vid cookie
  ip_hash TEXT,                    -- sha256(ip + staticSalt)
  user_agent TEXT,
  first_seen INTEGER,              -- epoch ms
  last_seen INTEGER,               -- epoch ms
  utm_source TEXT, utm_medium TEXT, utm_campaign TEXT, utm_content TEXT, utm_term TEXT,
  referrer TEXT
);

hits(
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  ts INTEGER,                      -- epoch ms
  sid TEXT,
  vid TEXT,
  path TEXT,
  event TEXT,                      -- 'page_view' (default) or custom event
  meta JSON                        -- freeform JSON string
);

purchases(
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  ts INTEGER,
  sid TEXT,
  vid TEXT,
  source TEXT,                     -- utm_source or referrer
  amount_cents INTEGER NULL,
  order_ref TEXT NULL
);

ignore_ips(ip_hash TEXT PRIMARY KEY);
ignore_uas(ua_pattern TEXT PRIMARY KEY);

BOT FILTERS AND DE-NOISE
1) On the server, derive isBot = userAgent matches any of:
   /(bot|crawler|spider|preview|fetch|monitor|scrape|facebookexternalhit|slackbot|twitterbot|linkedinbot|bingbot|googlebot|ahrefs|semrush|mj12|uptimerobot|whatsapp|telegrambot|discordbot)/i
2) Exclude requests whose path contains obvious CMS probes such as:
   '/wp-admin', '/wordpress', 'setup-config.php', '/.git', '/phpmyadmin'
3) Ignore requests where host ends with repl.dev or from my own session if vid matches a “DEV_TEST” toggle in code.
4) De-duplicate “unique” by vid per day (UTC).

VISITOR AND SESSION LOGIC
- On every page, include a small client script:
  • Sets a 1-year cookie 'layla_vid' (uuid v4) if missing.
  • Sets 'layla_sid' when a new session starts (new visitor or 30 minutes idle).
  • Captures current path, document.referrer and UTM params from the URL.
  • Sends a POST to /api/track with {event:'page_view', path, vid, sid, referrer, utms, userAgent}.
- Provide a lightweight no-JS fallback pixel at /p.gif that records a hit then returns a 1x1 gif.

EVENTS TO TRACK
- page_view (automatic)
- click_ticket (when the Tickets button is clicked)
- purchase (via redirect or webhook)

TICKETS REDIRECT AND PURCHASE CAPTURE
- Replace the external Tickets href with a local route: /out/tickets
- /out/tickets should:
  • Record an event {event:'click_ticket', path:'/out/tickets'}
  • Preserve and attach UTM params (from cookie or current request)
  • 302 redirect to the real Luma URL
- Add an optional webhook endpoint POST /webhooks/luma to accept JSON like:
  { order_ref, amount_cents, email, utms, referrer }
  If webhook is not configured, also support a simple thank-you fallback:
  GET /thank-you?order=<id>&amount=<pounds>
  Either route inserts a row in purchases and links it to session by vid if present.
- Store source on purchase as utm_source if present, else top-level referrer domain.

SERVER ENDPOINT /api/track (REPLACE IT)
Accept JSON: { event, path, vid, sid, utms:{...}, referrer, userAgent }
Steps:
  1) Validate and normalise.
  2) Compute ip_hash = sha256(ip + staticSalt) with a hardcoded salt 'layla-static-salt' for now.
  3) If isBot or path is blocked or ip_hash in ignore_ips or UA matches ignore_uas, return 204.
  4) Upsert session by sid. If missing, insert. Update last_seen, copy utms and referrer if newly seen.
  5) Insert into hits.
  6) Return { ok:true }.

DASHBOARD UI AT /layla-analytics-aurora-741
Keep the current look, and add these cards and charts:

Top row cards:
- Today’s Uniques (bot-filtered), with “X of 150” progress bar.
- Today’s Page Views.
- Ticket Clicks Today.
- Purchases Today.
- Live Visitors (count of sessions active in last 5 minutes).

Funnel section:
Visitors → Ticket Clicks → Purchases
Show today and last 7 days side by side.

Daily uniques chart:
- Last 30 days, bot-filtered, one dot per day.

Source performance:
- Table by utm_source or referrer domain for last 7 days:
  Visitors, Ticket CTR, Purchases, Conv rate to purchase.

Top referrers:
- Last 7 days, list with counts.

Recent activity:
- Last 25 hits with ts, event, path, source.

Controls:
- Toggle “Exclude bots” (default on).
- Toggle “Exclude my IPs” (manage ignore list).
- Toggle “Exclude dev domains”.

IMPLEMENTATION NOTES
- Add tiny client script injected into all pages (including home) with:
  - UTM capture to localStorage
  - Safe fetch('/api/track') with keepalive for unload
  - Click listener on any <a data-ticket-link> to hit /out/tickets
- Export a helper getSource(session) that prefers utm_source else referrer domain.
- Create a small domain parser to reduce referrers to root domains.
- Use dayjs (or vanilla) for date ranges. Use Chart.js for the chart.

ROUTES TO ADD
GET  /layla-analytics-aurora-741         -- renders dashboard HTML
GET  /api/stats/summary?range=today|7d|30d
GET  /api/stats/funnel?range=today|7d
GET  /api/stats/daily-uniques?days=30
GET  /api/stats/top-referrers?days=7
GET  /api/stats/sources?days=7
GET  /api/stats/recent?limit=25
POST /api/track
GET  /out/tickets                         -- click capture then 302 to Luma
POST /webhooks/luma                       -- optional purchase webhook
GET  /thank-you                           -- fallback purchase capture
GET  /p.gif                               -- 1x1 tracking pixel
POST /api/ignore/ip                       -- add current ip_hash to ignore list
POST /api/ignore/ua                       -- add UA pattern to ignore list

FRONTEND HOOKS
- Add data-ticket-link to the Tickets button and point it to /out/tickets.
- Inject the client tracker script in the site layout so it runs on all pages.

ACCEPTANCE TESTS (run these manually now)
1) Open site in a private window. Load the home page. The dashboard shows Today’s Uniques = 1 and Page Views increases by 1.
2) Click Tickets. Dashboard shows Ticket Clicks Today increases by 1, and the funnel updates. You are redirected to the Luma page.
3) Hit /thank-you?order=TEST123&amount=0 in the same private window. Purchases Today increases by 1, and funnel Purchase increases.
4) Open the home page in two new private windows. Today’s Uniques becomes 3. Refreshing one of them should not increase uniques.
5) Visit the site with a query string ?utm_source=linkedin&utm_campaign=test. The Sources table shows linkedin with a visitor and CTR after clicking Tickets.
6) Visit /wp-admin/setup-config.php. The request is ignored and not counted.
7) Toggle “Exclude bots” and confirm counts do not change meaningfully for normal traffic.

DELIVERABLES
- Updated server routes and DB schema.
- Injected client tracker script and Tickets redirect.
- Refreshed dashboard with the new cards, chart and tables.
- Clear inline comments so I can adapt the salt or add webhook secret later.

When done, print the exact Luma URL you wired under /out/tickets and confirm the dashboard shows the five top cards and a 150-visitors progress bar.